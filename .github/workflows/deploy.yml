- name: Deploy to Lightsail via SSH
  uses: appleboy/ssh-action@v1.1.0
  with:
    host: ${{ secrets.LIGHTSAIL_HOST }}
    username: ${{ secrets.LIGHTSAIL_USER }}
    key: ${{ secrets.LIGHTSAIL_SSH_KEY_B64 }}
    passphrase: ""
    port: 22
    script: |
      echo "$LIGHTSAIL_SSH_KEY_B64" | base64 --decode > /tmp/id_rsa
      chmod 600 /tmp/id_rsa

      echo "Stopping old container..."
      sudo docker stop node_app || true
      sudo docker rm node_app || true

      echo "Pulling latest image..."
      sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ github.sha }}

      echo "Starting new container..."
      sudo docker run -d --restart=always \
        -e NODE_ENV=production \
        -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
        -e CLOUDINARY_CLOUD_NAME="${{ secrets.CLOUDINARY_CLOUD_NAME }}" \
        -e CLOUDINARY_API_KEY="${{ secrets.CLOUDINARY_API_KEY }}" \
        -e CLOUDINARY_API_SECRET="${{ secrets.CLOUDINARY_API_SECRET }}" \
        -p 3000:3000 \
        --name node_app ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ github.sha }}

      echo "âœ… Deployment completed successfully!"
